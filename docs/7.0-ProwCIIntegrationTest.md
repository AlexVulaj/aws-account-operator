# 7.0 Prow CI Integration Test Framework

Content:

- [7.0 Prow CI Integration Test Framework](#70-prow-ci-integration-test-framework)
  - [7.1 - CI Operator Tooling(Prow)](#71-ci-operator-toolingprow)
  - [7.2 - CI Operator & AWS Account Operator](#72-ci-operator--aws-account-operator)
    - [7.2.1 - Steps for updating AAO Prow configuration](#721-steps-for-updating-aao-prow-configuration)
  - [7.3 - Integration test CI step configuration](#73-integration-test-prow-ci-step-configuration)
  - [7.4 - Integration Test Script](#74-integration-test-script)
    - [7.4.1 - Integration Test flow diagram](#741-integration-test-flow-diagram)
    - [7.4.2 - Integration Test flow diagram](#742-artifacts-and-logs-of-test-steps)

## 7.1 CI Operator Tooling(Prow)

The [CI Operator](https://docs.ci.openshift.org/docs/architecture/ci-operator/) or Openshift CI is a set of tools designed for use with Github repositories present in [Openshift Organization](https://github.com/openshift). It helps to perform end-to-end test suites to focus on the content of their tests and hiding the compexity of assembling an infrastructure for openshift cluster setup and installation. Openshift CI uses pipelines, builds and image streams extensively to achieve e2e test step runs.

## 7.2 CI Operator & AWS Account Operator

![Openshift CI Flow Diagram](/docs/images/prow-CI.png)

AWS Account Operator in particular uses Openshift CI to define and run Prow jobs when PRs are submitted, altered or merged. CI operator tooling documentation defines a way to setup CI flow for any repository.

AWS Account Operator has an existing Prow configuration present [here](https://github.com/openshift/release/blob/master/ci-operator/config/openshift/aws-account-operator/openshift-aws-account-operator-master.yaml).
  
### 7.2.1 Steps for updating AAO Prow configuration
  - Perform changes in existing configuration [here](https://github.com/openshift/release/blob/master/ci-operator/config/openshift/aws-account-operator/openshift-aws-account-operator-master.yaml)
  - Execute `make update`(assure docker service is running). This `update` target will update [jobs files](https://github.com/openshift/release/blob/master/ci-operator/config/openshift/aws-account-operator/openshift-aws-account-operator-master.yaml) according to changes done in above step.
  - openshift/release PR runs a rehearsal step against AAO master as part of presubmit check using the updated prow configuration. Watch for step named - `ci/rehearse/openshift/aws-account-operator-master-integration-test`
  - commit and merge changes to [release repository](https://github.com/openshift/release)

## 7.3 Integration test prow CI step configuration
  - Configured a new presubmit CI step named `integration-test` [here](https://github.com/openshift/release/blob/master/ci-operator/config/openshift/aws-account-operator/openshift-aws-account-operator-master.yaml)
  - *Temporary* - Configured it to be optional, such that it doesn't block the merge if this new step fails. [Reference](https://docs.ci.openshift.org/docs/architecture/ci-operator/#pre-submit-tests)
  - Added a cluster claim for using a clean openshift cluster everytime a integration test step is performed, labels are used to claim cluster from desired cluster pool. [Reference](https://docs.ci.openshift.org/docs/how-tos/cluster-claim/#use-the-cluster-pool-from-a-ci-job)
  - Environment variables are required for setting up secrets & configmaps for operator deployments and credentials file for awscli, for this we use vault collection named `aao-aws-credentials` configured [here](https://vault.ci.openshift.org/ui/vault/secrets/kv/list/selfservice/aao-aws-credentials/) with collection configuration present [here](https://selfservice.vault.ci.openshift.org/secretcollection?ui=true). For managing credentials members need to be added/configured to above collection. [Reference](https://docs.ci.openshift.org/docs/how-tos/adding-a-new-secret-to-ci/)
  - Secrets are used in the CI step by defining `mount_path`,`secret name`  and `namespace` under `credentials` label. [Reference](https://docs.ci.openshift.org/docs/architecture/step-registry/#injecting-custom-credentials)
  - Add `max_concurrency: 1`, [here](https://github.com/openshift/release/blob/master/ci-operator/jobs/openshift/aws-account-operator/openshift-aws-account-operator-master-presubmits.yaml). It is needed to block concurrent runs of same CI step in different PRs/Pipeline runs.
  Integration Step uses awscli credentials which are meant to be used one at a time for similar test cases, so to avoid concurrency we use `max_concurrency`
  - TODO- ADD A POINT ABOUT BLOCKING CERTAIN PRs
  - Finally, via commands label we trigger the makefile target named `prow-ci-deploy` present in AAO repository [here](https://github.com/openshift/aws-account-operator/blob/master/Makefile)

## 7.4 Integration Test Script
  - Bash script present [here](/hack/scripts/prow-ci-operator-deploy.sh) acts as an entrypoint to trigger integration-test for prow, staging and local crc cluster.
  - Here we only discuss the flow pertaining to Prow CI int-test flow, below is the sequential flow:-
    1. **parseArgs** - this determines which flow script need to run. For prow, no arguments are needed.
    2. **cleanup** - Cleanups are needed as we might end up using a cluster already containing an existing aws-account-operator namespace and other manifests, also some cleanup are required when ran locally. Cleanups run at start and end of the job. Here are the cleanups that are performed:-
        - aws-account-opeartor namespace
        - Dockerfile soft link (created via script)
        - Operator Deployment
        - Kustomization yaml files (create via script)
    3. **getEnvVariables** - Environment variables are extracted from the secret mount discussed above. This secret mount files contains all the secrets defined in the vault collection.
    4. **preDeploy** - This step deploys manifests present in [deploy directory](/deploy). These manifests are:-
        - CRDs
        - Secret
        - Config Map
        - RBACs
    5. **buildOperatorImage** - This step creates aws-account-operator imagestream using multiple steps:-
        - create a Dockerfile softlink at root linking to [Dockerfile](/build/Dockerfile).
        - Create a new buildconfig, passing args `FIPS_ENABLED=false`
        - Start a build using above config and passing the source directory as binary input to build config, imagestream is created in namespace aws-account-operator.
        - Set the image-lookup for the imagestream to true, such that the image can be fetched by the imagestream name not the registry link.
        - Verify build completion by checking if the `status.phase` of the build pod is `Complete`.
    6. **deployOperator** - This step uses above created imagestream to be deployed as a pod using the deployment present [here](/deploy//operator.yaml). This yaml is used as a template and updated using `oc -k`(kustomize) with below changes:-
        - image: aws-account-operator:latest
        - add env variable `FORCE_DEV_MODE: cluster`
    7. **installProwCIDependencies** - Since the existing tests are written in bash script, they use awscli & jq libraries which were need to be present in the container pod. So it install dependencies:-
        - jq - dependency to read fields in a json object returned by `oc`
        - awscli- test cases need to run aws commands using aws credentials, to achieve that awscli and credentials files are setup as part of this step.
    8. Trigger existing integration tests.

    ### 7.4.1 Integration Test flow diagram
    ![Openshift CI Flow Diagram](./images/aao-integration-test.png)

    ### 7.4.2 Artifacts and logs of test steps
    - For all the job history, go [here](https://prow.ci.openshift.org/job-history/gs/origin-ci-test/pr-logs/directory/pull-ci-openshift-aws-account-operator-master-integration-test)
    - Select a revision's build triggered by the PR for which you want logs.
    - Click artifacts and for logs follow path `artifacts -> integration-test -> test -> build-log.txt`, for eg.:- [here](https://gcsweb-ci.apps.ci.l2s4.p1.openshiftapps.com/gcs/origin-ci-test/pr-logs/pull/openshift_aws-account-operator/709/pull-ci-openshift-aws-account-operator-master-integration-test/1554383241438302208/artifacts/integration-test/test/build-log.txt)
